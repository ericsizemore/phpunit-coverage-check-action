name: "Build Docker image"

on:
  push:
    tags:
      - '*.*.*'

jobs:
  docker:
    name: "Push tagged docker image"
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      packages: write
      contents: read
      attestations: write

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref_name }}

      - name: "Docker login"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build images"
        run: docker build -t ghcr.io/ericsizemore/phpunit-coverage-check-action:${{ github.ref_name }} -t ghcr.io/ericsizemore/phpunit-coverage-check-action:latest .

      - name: "Publish"
        run: |
          docker push ghcr.io/ericsizemore/phpunit-coverage-check-action:${{ github.ref_name }}
          docker push ghcr.io/ericsizemore/phpunit-coverage-check-action:latest

      - name: "Get digest"
        id: get-digest
        run: |
          digest=$(docker manifest inspect ghcr.io/ericsizemore/phpunit-coverage-check-action:${{ github.ref_name }} -v | jq -r '.Descriptor.digest')
          echo "digest=$digest" >> "$GITHUB_OUTPUT"

      - name: "Generate SBOM"
        id: generate-sbom
        run: |
          # Install syft if not already available
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          
          # Generate SBOM from the Docker image (includes OS + application dependencies)
          syft ghcr.io/ericsizemore/phpunit-coverage-check-action:latest \
            -o spdx-json \
            > ${{ github.workspace }}/sbom.json
            
      - name: "Attest provenance + SBOM"
        uses: actions/attest@v4
        id: attest
        with:
          subject-name: ghcr.io/ericsizemore/phpunit-coverage-check-action
          subject-digest: ${{ steps.get-digest.outputs.digest }}
          sbom-path: sbom.json
          push-to-registry: false
